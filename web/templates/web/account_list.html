{% extends 'web/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
<style>
  .collapse,
  .collapsing {
    transition: none !important;
  }
  span[data-value],
  .toggle-visibility {
    cursor: pointer;
  }
  .copy-tooltip {
    position: absolute;
    top: 100%;
    left: 0;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8rem;
    white-space: nowrap;
    z-index: 1200;
  }
  @media (max-width: 576px) {
    td, th {
      padding: .3rem;
      font-size: 0.85rem;
    }
    h1 {
      font-size: 1.25rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 gap-2">
    <h1 class="mb-0">
      {% if selected_category %}
        Bank Accounts in “{{ selected_category.name }}”
      {% else %}
        All Bank Accounts
      {% endif %}
    </h1>
    <a
      href="{% url 'account_add' %}{% if selected_category %}?category={{ selected_category.id }}{% endif %}"
      class="btn btn-success"
    >
      + Add Bank Account
    </a>
  </div>

  {% if accounts %}
    <div class="mb-3">
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="Search by title..."
      >
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle position-relative" id="accountTable">
        <thead class="table-light">
          <tr>
            <th>Title</th>
            <th>Routing Number</th>
            <th>Account Number</th>
            <th>Holder Name</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for a in accounts %}
          <tr>
            <td class="title-cell">{{ a.title }}</td>

            <td>
              {% if a.routing_number %}
                <div class="position-relative d-inline-block">
                  <span class="masked me-2" data-value="{{ a.routing_number }}" id="routing{{ a.id }}">••••••••</span>
                  <i class="bi bi-eye-fill toggle-visibility" data-target="routing{{ a.id }}"></i>
                </div>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              {% if a.account_number %}
                <div class="position-relative d-inline-block">
                  <span class="masked me-2" data-value="{{ a.account_number }}" id="accNum{{ a.id }}">••••••••</span>
                  <i class="bi bi-eye-fill toggle-visibility" data-target="accNum{{ a.id }}"></i>
                </div>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              {% if a.account_holder_name %}
                <div class="position-relative d-inline-block">
                  <span class="masked me-2" data-value="{{ a.account_holder_name }}" id="holder{{ a.id }}">••••••••</span>
                  <i class="bi bi-eye-fill toggle-visibility" data-target="holder{{ a.id }}"></i>
                </div>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td class="position-relative" style="white-space: nowrap;">
              {% if a.description %}
                <button
                  class="btn btn-sm btn-info"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#descAcc{{ a.id }}"
                >
                  Description
                </button>
                <div
                  class="collapse position-absolute bg-white border rounded pt-4 pb-2 px-2 text-break"
                  id="descAcc{{ a.id }}"
                  style="z-index:1050;top:100%;left:0;min-width:200px;max-width:300px;max-height:200px;overflow:auto;"
                >
                  <button
                    type="button"
                    class="btn-close position-absolute top-0 end-0 m-2"
                    data-bs-toggle="collapse"
                    data-bs-target="#descAcc{{ a.id }}"
                  ></button>
                  {{ a.description|linebreaksbr }}
                </div>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <!-- Actions -->
            <td>
              <a href="{% url 'account_edit' a.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
              <a href="{% url 'account_delete' a.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">
      {% if selected_category %}
        There are no bank accounts in this category yet.
      {% else %}
        No bank accounts available.
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchInput');
  const table = document.getElementById('accountTable');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const filter = searchInput.value.trim().toLowerCase();
      table.querySelectorAll('tbody tr').forEach(row => {
        const title = row.querySelector('.title-cell').textContent.toLowerCase();
        row.style.display = title.includes(filter) ? '' : 'none';
      });
    });
  }

  document.querySelectorAll('.toggle-visibility').forEach(icon => {
    icon.addEventListener('click', () => {
      const span = document.getElementById(icon.dataset.target);
      if (!span) return;
      const isMasked = span.classList.contains('masked');
      if (isMasked) {
        span.textContent = span.dataset.value;
        icon.classList.replace('bi-eye-fill', 'bi-eye-slash-fill');
      } else {
        const dots = '•'.repeat(span.dataset.value.length);
        span.textContent = dots;
        icon.classList.replace('bi-eye-slash-fill', 'bi-eye-fill');
      }
      span.classList.toggle('masked');
    });
  });

  document.querySelectorAll('.masked').forEach(span => {
    span.addEventListener('click', () => {
      if (!span.dataset.value) return;
      navigator.clipboard.writeText(span.dataset.value).then(() => {
        const container = span.parentElement;
        const old = container.querySelector('.copy-tooltip');
        if (old) old.remove();
        const tip = document.createElement('div');
        tip.className = 'copy-tooltip';
        tip.textContent = 'Copied';
        container.appendChild(tip);
        setTimeout(() => tip.remove(), 1000);
      });
    });
  });
});
</script>
{% endblock %}
